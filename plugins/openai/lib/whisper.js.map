{"version":3,"sources":["../src/whisper.ts"],"sourcesContent":["/**\n * Copyright 2024 The Fire Company\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Message } from '@genkit-ai/ai';\nimport {\n  GenerationCommonConfigSchema,\n  defineModel,\n  modelRef,\n  type GenerateRequest,\n  type GenerateResponseData,\n  type ModelAction,\n} from '@genkit-ai/ai/model';\nimport OpenAI from 'openai';\nimport {\n  type TranscriptionCreateParams,\n  type Transcription,\n} from 'openai/resources/audio/index.mjs';\nimport { z } from 'zod';\n\nexport const Whisper1ConfigSchema = GenerationCommonConfigSchema.extend({\n  language: z.string().optional(),\n  timestamp_granularities: z.array(z.enum(['word', 'segment'])).optional(),\n  response_format: z\n    .enum(['json', 'text', 'srt', 'verbose_json', 'vtt'])\n    .optional(),\n});\n\nexport const whisper1 = modelRef({\n  name: 'openai/whisper-1',\n  info: {\n    label: 'OpenAI - Whisper',\n    supports: {\n      media: true,\n      output: ['text', 'json'],\n      multiturn: false,\n      systemRole: false,\n      tools: false,\n    },\n  },\n  configSchema: Whisper1ConfigSchema,\n});\n\nfunction toWhisper1Request(\n  request: GenerateRequest<typeof Whisper1ConfigSchema>\n): TranscriptionCreateParams {\n  const message = new Message(request.messages[0]);\n  const media = message.media();\n  if (!media?.url) {\n    throw new Error('No media found in the request');\n  }\n  const mediaBuffer = Buffer.from(\n    media.url.slice(media.url.indexOf(',') + 1),\n    'base64'\n  );\n  const mediaFile = new File([mediaBuffer], 'input', {\n    type:\n      media.contentType ??\n      media.url.slice('data:'.length, media.url.indexOf(';')),\n  });\n  const options: TranscriptionCreateParams = {\n    model: 'whisper-1',\n    file: mediaFile,\n    prompt: message.text(),\n    temperature: request.config?.temperature,\n    language: request.config?.language,\n    timestamp_granularities: request.config?.timestamp_granularities,\n  };\n  const outputFormat = request.output?.format;\n  const customFormat = request.config?.response_format;\n  if (outputFormat && customFormat) {\n    if (\n      outputFormat === 'json' &&\n      customFormat !== 'json' &&\n      customFormat !== 'verbose_json'\n    ) {\n      throw new Error(\n        `Custom response format ${customFormat} is not compatible with output format ${outputFormat}`\n      );\n    }\n  }\n  if (outputFormat === 'media') {\n    throw new Error(`Output format ${outputFormat} is not supported.`);\n  }\n  options.response_format = customFormat || outputFormat || 'text';\n  for (const k in options) {\n    if (options[k] === undefined) {\n      delete options[k];\n    }\n  }\n  return options;\n}\n\nfunction toGenerateResponse(\n  result: Transcription | string\n): GenerateResponseData {\n  return {\n    candidates: [\n      {\n        index: 0,\n        finishReason: 'stop',\n        message: {\n          role: 'model',\n          content: [\n            {\n              text: typeof result === 'string' ? result : result.text,\n            },\n          ],\n        },\n      },\n    ],\n  };\n}\n\nexport function whisper1Model(\n  client: OpenAI\n): ModelAction<typeof Whisper1ConfigSchema> {\n  return defineModel<typeof Whisper1ConfigSchema>(\n    {\n      name: whisper1.name,\n      ...whisper1.info,\n      configSchema: whisper1.configSchema,\n    },\n    async (request) => {\n      const result = await client.audio.transcriptions.create(\n        toWhisper1Request(request)\n      );\n      return toGenerateResponse(result);\n    }\n  );\n}\n"],"mappings":"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","names":[]}